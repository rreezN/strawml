<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StrawML</title>
    <style>
        body {
            text-align: center;
            font-family: Arial, sans-serif;
        }
        img {
            max-width: 80%;
            height: auto;
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            margin: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Straw Level Monitor Evaluation</h1>
    <p>Select which line best fits the straw level in the chute. Press (R)ed for the red line, (G)reen for the green line or (E)qual if they are equal. If you are unsure, press (S)kip</p>
    <img id="random-image" alt="Random Image">
    <div>
        <button id="red" onclick="submitResponse('Red')">(R)ed</button>
        <button id="equal" onclick="submitResponse('Equal')">(E)qual</button>
        <button id="green" onclick="submitResponse('Green')">(G)reen</button>
        <button id="skip" onclick="fetchRandomImage()">(S)kip</button>
    </div>
    <script>
        let images = [];
    
        // Fetch the image list from the 'cloudinary.json' file
        fetch('data/processed/cloudinary.json')
            .then(response =>  {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Fetched data:', data);
                images = data; // Store the fetched image data in the images array
                console.log('Loaded image, total: ' + images.length);
                fetchRandomImage(); // Load the first random image
            })
            .catch(error => {
                console.error('Error loading image data:', error);
                document.body.innerHTML = '<h2>Failed to load images!</h2>';
            });
    
        // Function to display a random image and remove it from the list
        function fetchRandomImage() {
            if (images.length === 0) {
                document.body.innerHTML = '<h2>No images left!</h2>';
                return;
            }
            const randomIndex = Math.floor(Math.random() * images.length);
            const randomImage = images[randomIndex];

            // Display the image
            document.getElementById('random-image').src = randomImage.url;
            document.getElementById('random-image').dataset.url = randomImage.url;
            document.getElementById('random-image').dataset.tags = JSON.stringify(randomImage.tags); // Save tags in a data attribute
    
            // Remove the displayed image from the list
            images.splice(randomIndex, 1); 
        }
    
        function handleHotkeys(event) {
            switch (event.key) {
                case 'r':
                    submitResponse('Red');
                    break;
                case 'e':
                    submitResponse('Equal');
                    break;
                case 'g':
                    submitResponse('Green');
                    break;
                case 's':
                    fetchRandomImage();
                    break;
            }
        }

        document.addEventListener('keydown', handleHotkeys);

        // Function to handle the user's response (choice Red or Green)
        function submitResponse(choice) {
            const imgElement = document.getElementById('random-image');
            const imageUrl = imgElement.dataset.url;
            const tags = imgElement.dataset.tags ? JSON.parse(imgElement.dataset.tags) : []; // Parse tags from the data attribute

            // Extract YOLO and SCADA values from tags
            let yoloValue = null
            let scadaValue = null

            tags.forEach(tag => {
                if (tag.startsWith('yolo:')) {
                    yoloValue = tag.split(':')[1];
                    return false;
                } else if (tag.startsWith('scada:')) {
                    scadaValue = tag.split(':')[1];
                    return false;
                }
                return true;
            });

            // Send the response to the Google Apps Script Web App URL without waiting for the response
            fetch('https://script.google.com/macros/s/AKfycbycvWi6Hb0B3YJR7p1CfNaXeiNiQKBSx7SeBPhoLxfxSIl7u1sV_y8xknL2LLi1MHmP/exec', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'imageUrl': imageUrl,
                    'tags': tags.join(','),
                    'yolo': yoloValue || '',
                    'scada': scadaValue || '',
                    'choice': choice
                })
            }).catch(error => {
                console.error("Error storing response:", error);
            });

            // Load the next image immediately without waiting for the response
            fetchRandomImage();
        }
    </script>
</body>
</html>
